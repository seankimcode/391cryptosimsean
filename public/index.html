<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Crypto Trading Simulator</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar-->
        <div class="border-end bg-dark text-white" id="sidebar-wrapper">
            <div class="sidebar-heading border-bottom bg-secondary text-white">Crypto Sim</div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="#" onclick="showPage('portfolio_div')">Portfolio</a>
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="#" onclick="showPage('trade_div')">Trade</a>
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="market.html">Market</a>
            </div>
        </div>
        <!-- Page content wrapper-->
        <div id="page-content-wrapper">
            <!-- Top navigation-->
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom custom-navbar">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                            <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- Page content-->
            <div class="container-fluid">
                <div id="login_div" class="page active">
                    <h3>Login:</h3>
                    <input type="email" id="email_field" class="form-control mb-3" placeholder="Enter email"/>
                    <input type="password" id="password_field" class="form-control mb-3" placeholder="Enter password"/>
                    <button onclick="login()" class="btn btn-primary">Login</button>
                    <button onclick="createAccount()" class="btn btn-secondary">Create Account</button>
                </div>

                <div id="app" style="display: none;">
                    <div id="portfolio_div" class="page">
                        <h3>Portfolio</h3>
                        <div id="portfolio_content">
                            <!-- Portfolio content will go here -->
                        </div>
                        <h4>Portfolio Value Over Time</h4>
                        <canvas id="portfolioChart"></canvas>
                        
                    </div>

                    <div id="trade_div" class="page" style="display: none;">
                        <h3>Trade</h3>
                        <form onsubmit="return performTrade(event)">
                            <label for="crypto">Cryptocurrency:</label>
                            <input type="text" id="crypto" name="crypto" class="form-control mb-3" placeholder="e.g., bitcoin" required>
                            <label for="amount">Amount:</label>
                            <input type="number" id="amount" name="amount" class="form-control mb-3" required>
                            <button type="submit" class="btn btn-primary">Trade</button>
                        </form>
                        <div id="trade_content">
                            <h4>Trade History</h4>
                            <div id="trade_history">
                                <!-- Trade history will go here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDl35KtU9I_qL2_UUSiwi1ckfw6kmvsRyY",
            authDomain: "cryptosimsean.firebaseapp.com",
            projectId: "cryptosimsean",
            storageBucket: "cryptosimsean.appspot.com",
            messagingSenderId: "205429209021",
            appId: "1:205429209021:web:2f0a0a9c62eb4e2f03c9a7",
            measurementId: "G-X8X1VZQEX8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Firebase Authentication
        window.createAccount = async function() {
            const email = document.getElementById('email_field').value;
            const password = document.getElementById('password_field').value;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('Account created successfully!');
                showAuthenticatedUI();
            } catch (error) {
                alert('Error creating account: ' + error.message);
            }
        }

        window.login = async function() {
            const email = document.getElementById('email_field').value;
            const password = document.getElementById('password_field').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                alert('Logged in successfully!');
                showAuthenticatedUI();
            } catch (error) {
                alert('Error logging in: ' + error.message);
            }
        }

        window.logout = async function() {
            try {
                await signOut(auth);
                alert('Logged out successfully!');
                document.getElementById('login_div').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            } catch (error) {
                alert('Error logging out: ' + error.message);
            }
        }

        function showAuthenticatedUI() {
            document.getElementById('login_div').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            showPage('portfolio_div');
            loadPortfolio();
            loadTradeHistory();
        }

        // Show the specified page and hide others
        window.showPage = function(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }

        // Fetch data from CoinGecko API
        async function fetchCryptoPrice(crypto) {
            const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${crypto}&vs_currencies=usd`);
            const data = await response.json();
            return data[crypto].usd;
        }

        // Fetch data for all cryptos in the portfolio
        async function fetchPortfolioPrices(portfolio) {
            const prices = {};
            for (const crypto in portfolio) {
                prices[crypto] = await fetchCryptoPrice(crypto);
            }
            return prices;
        }

        // Add portfolio management functions
        async function loadPortfolio() {
            const user = auth.currentUser;
            if (user) {
                const portfolioRef = doc(db, "portfolios", user.uid);
                const portfolioDoc = await getDoc(portfolioRef);

                if (portfolioDoc.exists()) {
                    const portfolioData = portfolioDoc.data();
                    const prices = await fetchPortfolioPrices(portfolioData);
                    displayPortfolio(portfolioData, prices);
                    await updatePortfolioChart();
                } else {
                    console.log("No portfolio found.");
                    document.getElementById('portfolio_content').innerText = "No portfolio found.";
                }
            } else {
                console.log("No user logged in.");
            }
        }

        function displayPortfolio(portfolioData, prices) {
            const portfolioContent = document.getElementById('portfolio_content');
            portfolioContent.innerHTML = '';

            let totalValue = 0;

            for (const [crypto, amount] of Object.entries(portfolioData)) {
                const value = amount * prices[crypto];
                totalValue += value;

                const item = document.createElement('div');
                item.innerText = `${crypto}: ${amount} (${value.toFixed(2)} USD)`;
                portfolioContent.appendChild(item);
            }

            const totalValueItem = document.createElement('div');
            totalValueItem.innerText = `Total Portfolio Value: ${totalValue.toFixed(2)} USD`;
            portfolioContent.appendChild(totalValueItem);
        }

        async function updatePortfolio(crypto, amount) {
            const user = auth.currentUser;
            if (user) {
                const portfolioRef = doc(db, "portfolios", user.uid);
                const portfolioDoc = await getDoc(portfolioRef);
                let portfolioData = {};
                if (portfolioDoc.exists()) {
                    portfolioData = portfolioDoc.data();
                }
                if (portfolioData[crypto]) {
                    portfolioData[crypto] += amount;
                } else {
                    portfolioData[crypto] = amount;
                }
                await setDoc(portfolioRef, portfolioData);
                const prices = await fetchPortfolioPrices(portfolioData);
                displayPortfolio(portfolioData, prices);
                addTradeToHistory(crypto, amount);

                // Save historical portfolio value
                const totalValue = Object.entries(portfolioData).reduce((total, [crypto, amount]) => {
                    return total + (amount * prices[crypto]);
                }, 0);
                const historyRef = doc(db, "portfolioHistory", user.uid);
                await setDoc(historyRef, {
                    [new Date().toISOString()]: totalValue
                }, { merge: true });

                await updatePortfolioChart();
            } else {
                console.log("No user logged in.");
            }
        }

        window.performTrade = async function(event) {
            event.preventDefault();
            const crypto = document.getElementById('crypto').value.toLowerCase();
            const amount = parseFloat(document.getElementById('amount').value);

            if (crypto && !isNaN(amount)) {
                await updatePortfolio(crypto, amount);
                alert('Trade successful!');
            } else {
                alert('Invalid trade details.');
            }
        }

        function addTradeToHistory(crypto, amount) {
            const user = auth.currentUser;
            if (user) {
                const tradeHistoryRef = collection(db, "tradeHistory", user.uid, "history");
                addDoc(tradeHistoryRef, {
                    crypto: crypto,
                    amount: amount,
                    timestamp: new Date()
                });
            }
        }

        async function loadTradeHistory() {
            const user = auth.currentUser;
            if (user) {
                const tradeHistoryRef = collection(db, "tradeHistory", user.uid, "history");
                const q = query(tradeHistoryRef, orderBy("timestamp", "asc"));
                onSnapshot(q, (querySnapshot) => {
                    const tradeHistory = document.getElementById('trade_history');
                    tradeHistory.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const item = document.createElement('div');
                        item.innerText = `Traded ${data.amount} of ${data.crypto} on ${data.timestamp.toDate().toLocaleString()}`;
                        tradeHistory.appendChild(item);
                    });
                });
            } else {
                console.log("No user logged in.");
            }
        }

        // Portfolio chart
        let portfolioChart;
        async function updatePortfolioChart() {
            const user = auth.currentUser;
            if (user) {
                const historyRef = doc(db, "portfolioHistory", user.uid);
                const historyDoc = await getDoc(historyRef);
                if (historyDoc.exists()) {
                    const historyData = historyDoc.data();
                    const labels = Object.keys(historyData).map(timestamp => new Date(timestamp));
                    const data = Object.values(historyData);

                    const ctx = document.getElementById('portfolioChart').getContext('2d');
                    if (portfolioChart) {
                        portfolioChart.destroy();
                    }
                    portfolioChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Portfolio Value Over Time',
                                data: data,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                fill: false
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        tooltipFormat: 'll',
                                        displayFormats: {
                                            day: 'MMM D'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Portfolio Value (USD)'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Value: $${context.raw.toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.log("No historical data available.");
                }
            }
        }

        // Refresh portfolio prices every hour
        setInterval(loadPortfolio, 3600000);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showAuthenticatedUI();
                loadPortfolio();
            } else {
                document.getElementById('login_div').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        });
    </script>
</body>
</html>
