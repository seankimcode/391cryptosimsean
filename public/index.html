<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Crypto Trading Simulator</title>
    <!-- Favicon-->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar-->
        <div class="border-end bg-dark text-white" id="sidebar-wrapper">
            <div class="sidebar-heading border-bottom bg-secondary text-white">Crypto Sim</div>
            <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="#" onclick="showPage('portfolio_div')">Portfolio</a>
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="#" onclick="showPage('trade_div')">Trade</a>
                <a class="list-group-item list-group-item-action bg-dark text-white p-3" href="market.html">Market</a>
            </div>
        </div>
        <!-- Page content wrapper-->
        <div id="page-content-wrapper">
            <!-- Top navigation-->
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom custom-navbar">
                <div class="container-fluid">
                    <button class="btn btn-primary" id="sidebarToggle">Toggle Menu</button>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                        <ul class="navbar-nav ms-auto mt-2 mt-lg-0">
                            <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- Page content-->
            <div class="container-fluid">
                <div id="login_div" class="page active">
                    <h3>Login:</h3>
                    <input type="email" id="email_field" class="form-control mb-3" placeholder="Enter email"/>
                    <input type="password" id="password_field" class="form-control mb-3" placeholder="Enter password"/>
                    <button onclick="login()" class="btn btn-primary">Login</button>
                    <button onclick="createAccount()" class="btn btn-secondary">Create Account</button>
                </div>

                <div id="app" style="display: none;">
                    <div id="portfolio_div" class="page">
                        <h3>Portfolio</h3>
                        <div id="portfolio_content">
                            <!-- Portfolio content will go here -->
                        </div>
                        <h4>Portfolio Value Over Time</h4>
                        <canvas id="portfolioChart"></canvas>
                    </div>

                    <div id="trade_div" class="page" style="display: none;">
                        <h3>Trade</h3>
                        <form onsubmit="return performTrade(event)">
                            <label for="crypto">Cryptocurrency:</label>
                            <input type="text" id="crypto" name="crypto" class="form-control mb-3" placeholder="e.g., bitcoin" required>
                            <label for="amount">Amount:</label>
                            <input type="number" id="amount" name="amount" class="form-control mb-3" required>
                            <button type="submit" class="btn btn-primary">Trade</button>
                        </form>
                        <div id="trade_content">
                            <h4>Trade History</h4>
                            <div id="trade_history">
                                <!-- Trade history will go here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS -->
    <script src="js/scripts.js"></script>
    
    <!-- Firebase SDK - Include specific Firebase products -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDl35KtU9I_qL2_UUSiwi1ckfw6kmvsRyY",
            authDomain: "cryptosimsean.firebaseapp.com",
            projectId: "cryptosimsean",
            storageBucket: "cryptosimsean.appspot.com",
            messagingSenderId: "205429209021",
            appId: "1:205429209021:web:2f0a0a9c62eb4e2f03c9a7",
            measurementId: "G-X8X1VZQEX8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Define showPage function here
        window.showPage = function(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }

        // Firebase Authentication
        window.createAccount = function() {
            const email = document.getElementById('email_field').value;
            const password = document.getElementById('password_field').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    alert('Account created successfully!');
                    showAuthenticatedUI();
                })
                .catch((error) => {
                    alert('Error creating account: ' + error.message);
                });
        }

        window.login = function() {
            const email = document.getElementById('email_field').value;
            const password = document.getElementById('password_field').value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    alert('Logged in successfully!');
                    showAuthenticatedUI();
                })
                .catch((error) => {
                    alert('Error logging in: ' + error.message);
                });
        }

        window.logout = function() {
            signOut(auth).then(() => {
                alert('Logged out successfully!');
                document.getElementById('login_div').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }).catch((error) => {
                alert('Error logging out: ' + error.message);
            });
        }

        function showAuthenticatedUI() {
            document.getElementById('login_div').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            showPage('portfolio_div');
        }

        // Fetch data from CoinGecko API
        window.fetchCryptoData = async function() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd&x_cg_demo_api_key=CG-GWH6d4aEUY66FHYcP3WMP8c1');
                const data = await response.json();
                console.log('Crypto Prices:', data);
            } catch (error) {
                console.error('Error fetching data from CoinGecko:', error);
            }
        }

        // Show the specified page and hide others
        window.showPage = function(pageId) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');
            document.getElementById(pageId).style.display = 'block';
        }

        // Add portfolio management functions
        async function loadPortfolio() {
            const user = auth.currentUser;
            if (user) {
                const portfolioRef = doc(db, "portfolios", user.uid);
                const portfolioDoc = await getDoc(portfolioRef);

                if (portfolioDoc.exists()) {
                    const portfolioData = portfolioDoc.data();
                    const prices = await fetchPortfolioPrices(portfolioData);
                    displayPortfolio(portfolioData, prices);
                    drawPortfolioChart(portfolioData, prices);
                } else {
                    console.log("No portfolio found.");
                    document.getElementById('portfolio_content').innerText = "No portfolio found.";
                }
            } else {
                console.log("No user logged in.");
            }
        }

        async function fetchPortfolioPrices(portfolio) {
            const prices = {};
            const cryptos = Object.keys(portfolio).join(',');
            const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptos}&vs_currencies=usd&x_cg_demo_api_key=CG-GWH6d4aEUY66FHYcP3WMP8c1`);
            const data = await response.json();
            for (const crypto in portfolio) {
                const normalizedCrypto = normalizeCryptoName(crypto);
                prices[normalizedCrypto] = data[normalizedCrypto]?.usd || 0;
            }
            return prices;
        }

        function displayPortfolio(portfolioData, prices) {
            const portfolioContent = document.getElementById('portfolio_content');
            portfolioContent.innerHTML = '';

            // Normalize crypto names to their standard CoinGecko IDs
            const normalizedPortfolio = {};
            for (const [crypto, amount] of Object.entries(portfolioData)) {
                const normalizedCrypto = normalizeCryptoName(crypto);
                if (normalizedPortfolio[normalizedCrypto]) {
                    normalizedPortfolio[normalizedCrypto] += amount;
                } else {
                    normalizedPortfolio[normalizedCrypto] = amount;
                }
            }

            for (const [crypto, amount] of Object.entries(normalizedPortfolio)) {
                const item = document.createElement('div');
                item.innerText = `${crypto}: ${amount} (${(amount * prices[crypto]).toFixed(2)} USD)`;
                portfolioContent.appendChild(item);
            }
        }

        function normalizeCryptoName(name) {
            const mapping = {
                'btc': 'bitcoin',
                'bitcoin': 'bitcoin',
                'eth': 'ethereum',
                'ethereum': 'ethereum'
                // Add more mappings as needed
            };
            return mapping[name.toLowerCase()] || name.toLowerCase();
        }

        async function updatePortfolio(crypto, amount) {
            const user = auth.currentUser;
            if (user) {
                const portfolioRef = doc(db, "portfolios", user.uid);
                const portfolioDoc = await getDoc(portfolioRef);
                let portfolioData = {};
                if (portfolioDoc.exists()) {
                    portfolioData = portfolioDoc.data();
                }
                const normalizedCrypto = normalizeCryptoName(crypto);
                if (portfolioData[normalizedCrypto]) {
                    portfolioData[normalizedCrypto] += amount;
                } else {
                    portfolioData[normalizedCrypto] = amount;
                }
                await setDoc(portfolioRef, portfolioData);
                const prices = await fetchPortfolioPrices(portfolioData);
                displayPortfolio(portfolioData, prices);
                addTradeToHistory(normalizedCrypto, amount);
            } else {
                console.log("No user logged in.");
            }
        }

        window.performTrade = async function(event) {
            event.preventDefault();
            const crypto = document.getElementById('crypto').value.toLowerCase();
            const amount = parseFloat(document.getElementById('amount').value);

            if (crypto && !isNaN(amount)) {
                await updatePortfolio(crypto, amount);
                alert('Trade successful!');
            } else {
                alert('Invalid trade details.');
            }
        }

        function addTradeToHistory(crypto, amount) {
            const tradeHistory = document.getElementById('trade_history');
            const tradeItem = document.createElement('div');
            tradeItem.innerText = `Traded ${amount} of ${crypto}`;
            tradeHistory.appendChild(tradeItem);
        }

        // Refresh portfolio prices every hour
        setInterval(loadPortfolio, 3600000);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showAuthenticatedUI();
                loadPortfolio();
            } else {
                document.getElementById('login_div').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }
        });

        // Function to draw the portfolio value over time chart
        function drawPortfolioChart(portfolioData, prices) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const labels = [];
            const data = [];

            for (const [crypto, amount] of Object.entries(portfolioData)) {
                const price = prices[normalizeCryptoName(crypto)];
                const value = amount * price;
                labels.push(crypto);
                data.push(value);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio Value Over Time',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
